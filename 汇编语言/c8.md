处理器和外围设备通过相应的I/O接口通信，具体的说是通过**端口**，

端口在不同的计算机系统有不同的实现方法，在一些计算机系统，端口号直接映射在内存地址空间，而在另一些计算机系统，端口是独立编址的。

在Intel处理器，早期是独立编址的，后来既有内存映射，又有独立编址。

本章只讨论独立编址

in/out指令用来访问端口

```asm
in al,dx  ;8位端口 al是从端口读取的数据，dx内存放的是端口号
in ax,dx  ;16位端口 in指令源操作数只能是dx或一字节立即数，目的操作数根据端口位数只能是al ax
in ax,0x03 ;源操作数是立即数时只能访问0~255号端口
in ax,0x23e ;不合法
```

```assembly
out dx,al  ;out指令和in指令相仿
out dx,ax  ;只是源操作数和目的操作数相反
out 0x34,al ;in指令和out指令不影响任何标志位
out 0x56,ax
```



#### 读写磁盘

磁盘是块设备，读写磁盘的基本单位是扇区。

经典的读写方法是CHS模式：向磁盘控制器分别发送柱面号(cylinder)，磁头(header)和扇区(sector)；

但在使用中我们一般不关心扇区的物理位置，我们希望所有扇区可以统一编址，这就是逻辑扇区，它把所有可用扇区从0开始编号。

最早的逻辑扇区编址方式是LBA28，使用28个比特表示逻辑扇区号，共可以表示$$2^28=268,435,456$$个扇区，而每个扇区有512个字节，所以LBA28可以管理128GB的硬盘。

目前业界又推出了LBA48，可以管理131072TB的硬盘。

本章使用LBA28

个人计算机的主硬盘控制器被分配了8个端口，端口号从0x1f0到0x1f7。

- 0x1f2端口：写入要读取的扇区数量，8位
- 0x1f3-0x1f6号端口：写入起始LBA扇区号，8位
  - 0x1f3号：0~7位
  - 0x1f4号：8~15位
  - 0x1f5号：16~23位
  - 0x1f6号：24~27位
  - ps: 在现行体系下，每个PATA/SATA接口允许挂接两块硬盘，分别是主盘和从盘，0x1f6低四位存放逻辑扇区号高四位，第四位指示硬盘号，高3位是‘111’，表示LBA模式。

- 0x1f7端口：命令和状态端口，8位
  - 写入0x20表示请求硬盘读
  - 在该端口第七位为‘1’时表示在忙；清零时表示忙完了，并把第3位置1，表示准备好了，请求主机发送或接受数据。
- 0x1f0端口：数据端口，16位 
- 0x1f1端口：错误寄存器，包含硬盘驱动器最后一次执行命令后的状态。